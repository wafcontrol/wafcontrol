{% extends 'dashboard/main/main.html' %}
{% load static %}
{% block content %}
    {% block title %}Admin Profile - Owasp Wafcontrol{% endblock %}

    <div id="content-page" class="content-page">
        <div class="container-fluid">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}

            <div class="row">
                <div class="col-lg-12">
                    <div class="iq-card">
                        <div class="iq-card-body p-0">
                            <div class="iq-edit-list">
                                <ul class="iq-edit-profile d-flex nav nav-pills">
                                    <li class="col-md-4 p-0">
                                        <a class="nav-link" id="tab-personal" data-toggle="pill"
                                           href="#personal-information">Personal Information</a>
                                    </li>
                                    <li class="col-md-4 p-0">
                                        <a class="nav-link" id="tab-password" data-toggle="pill"
                                           href="#change-password">Change Password</a>
                                    </li>
                                    <li class="col-md-4 p-0">
                                        <a class="nav-link" id="tab-2fa" data-toggle="pill" href="#two-factor">Two-Factor
                                            Authentication</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="iq-edit-list-data">
                        <div class="tab-content">
                            <!-- Personal Info -->
                            <div class="tab-pane fade" id="personal-information" role="tabpanel">
                                <div class="iq-card">
                                    <div class="iq-card-header d-flex justify-content-between">
                                        <div class="iq-header-title">
                                            <h4 class="card-title">Personal Information</h4>
                                        </div>
                                    </div>
                                    <div class="iq-card-body">
                                        <form method="post">
                                            {% csrf_token %}
                                            {{ profile_form.as_p }}
                                            <button type="submit" name="update_profile" class="btn btn-primary">Save
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Change Password -->
                            <div class="tab-pane fade" id="change-password" role="tabpanel">
                                <div class="iq-card">
                                    <div class="iq-card-header d-flex justify-content-between">
                                        <div class="iq-header-title">
                                            <h4 class="card-title">Change Password</h4>
                                        </div>
                                    </div>
                                    <div class="iq-card-body">
                                        <form method="post">
                                            {% csrf_token %}
                                            {{ password_form.as_p }}
                                            <button type="submit" name="change_password" class="btn btn-warning">Update
                                                Password
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Two-Factor Auth -->
                            <div class="tab-pane fade" id="two-factor" role="tabpanel">
                                <div class="iq-card">
                                    <div class="iq-card-header d-flex justify-content-between">
                                        <div class="iq-header-title">
                                            <h4 class="card-title">Two-Factor Authentication</h4>
                                        </div>
                                    </div>
                                    <div class="iq-card-body">
                                        {% if user.userprofile.two_factor_enabled %}
                                            <p class="text-success">2FA is currently <strong>enabled</strong> on your
                                                account.</p>
                                            <form method="post">
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    <label for="otp">Enter 6-digit code to disable 2FA:</label>
                                                    <input type="text" name="otp" class="form-control" required>
                                                </div>
                                                <button type="submit" name="disable_2fa" class="btn btn-danger">Disable
                                                    2FA
                                                </button>
                                            </form>
                                        {% else %}

                                            <p class="text-muted">To enhance your account security, enable Two-Factor
                                                Authentication (2FA).</p>
                                            {% if qr_code and secret %}
                                                <p>Scan this QR code with your authenticator app:</p>
                                                <img src="data:image/png;base64,{{ qr_code }}" alt="2FA QR Code"
                                                     class="mb-3" style="max-width: 200px;">
                                                <p>Or use this secret key: <code>{{ secret }}</code></p>
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <div class="form-group">
                                                        <label for="otp">Enter the 6-digit code from your app:</label>
                                                        <input type="text" name="otp" class="form-control" required>
                                                    </div>
                                                    <button type="submit" name="enable_2fa" class="btn btn-success">
                                                        Enable 2FA
                                                    </button>
                                                </form>
                                            {% else %}
                                                <form method="post">
                                                    {% csrf_token %}
                                                    <button type="submit" name="start_2fa" class="btn btn-info">Start
                                                        2FA Setup
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Auto-activate tab -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tab = "{{ active_tab|default:'personal-information' }}";
            if (tab) {
                document.querySelector(`a[href="#${tab}"]`)?.classList.add('active');
                document.querySelector(`#${tab}`)?.classList.add('show', 'active');
            }
        });
    </script>

{% endblock %}
